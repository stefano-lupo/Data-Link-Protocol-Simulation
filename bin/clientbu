import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.EOFException;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;
import java.net.SocketException;
import java.net.SocketTimeoutException;
import java.util.ArrayList;





public class MyClient {
	private static int portNum = 8084;
	private static String serverName = "localhost";

	private static ArrayList<Frame> frames;
	private static final int WINDOW_SIZE = 2;
	private static boolean running = false;

	private static Socket client;

	private static DataInputStream dataInputStream;
	private static DataOutputStream dataOutputStream;

	private static ObjectInputStream objectInputStream;
	private static ObjectOutputStream objectOutputStream;



	public static void main(String[] args){
		frames = new ArrayList<>();
		Sender sender = null;
		//Receiver receiver = null;
		try {
			client = new Socket(serverName, portNum);
			client.setSoTimeout(5000);

			sender = new Sender();
			//			receiver = new Receiver();
			//			receiver.start();
			running = true;
			sender.start();

			while(sender.isAlive()){
				
			}
			
			System.out.println("Sender dead..");
			/* To sender
			//dataInputStream = new DataInputStream(client.getInputStream());
			dataOutputStream = new DataOutputStream(client.getOutputStream());

			//objectInputStream = new ObjectInputStream(dataInputStream);
			objectOutputStream = new ObjectOutputStream(dataOutputStream);

			for(int i=0;i<10;i++){
				byte[] data = {(byte)(i+63)};
				System.out.println("sending frame");
				objectOutputStream.writeObject(new Frame((short)1, (short)1, data));
			}
			client.close();
			 */

		} catch (SocketException e) {
			System.out.println("Scoket exception");
		}
		catch (SocketTimeoutException e) {
			System.out.println("Timeout");
			running = false;
			//receiver.interrupt();
			//			receiver.interrupt();
			//			sender.interrupt();
			//client.close();
		}
		catch (IOException e) {
			e.printStackTrace();
		}


	}

	
	

	static class Sender extends Thread{

		@Override
		public void run(){
			try{
				//dataInputStream = new DataInputStream(client.getInputStream());
				dataOutputStream = new DataOutputStream(client.getOutputStream());

				//objectInputStream = new ObjectInputStream(dataInputStream);
				objectOutputStream = new ObjectOutputStream(dataOutputStream);

				for(int i=0;i<10;i++){
					byte[] data = {(byte)(i+63)};
					System.out.println("sending frame");
					objectOutputStream.writeObject(new Frame((short)1, (short)1, data));
				}
				try{
					join();
				} catch (InterruptedException e) {
					System.out.println("Exceiption in waiting for client sender thread to die");
				}
				//client.close();
			} catch (IOException e) {
				System.out.println("IOException");
			}
		}

		/*@Override
		public void run() {
			System.out.println("Sender run");
			int c = 0;
			short sequenceNumber = 1;
			FileInputStream in = null;

			try {
				in = new FileInputStream("src/data.txt");
			} catch (FileNotFoundException e) {
				e.printStackTrace();
			}

			System.out.println("Running starting : " + c + running);

			while((c != -1) && running) {
				System.out.println("Running");
				// Check if we can send next frame
				if(frames.size() < WINDOW_SIZE) {
					byte[] bytes = new byte[8];
					short byteCounter = 0;
					for(int i=0;i<8;i++) {
						try {
							c = in.read();
							if(c == -1) {
								break;
							} 
							bytes[i] = (byte)c;
							byteCounter++;
						} catch (IOException e) {
							System.out.println(e);
						}
					}
					Frame frame = new Frame(sequenceNumber, byteCounter, bytes);
					sendFrame(frame);
					sequenceNumber++;
				} else {
					try {
						System.out.println("Sleeping for 500ms");
						sleep(500);
					} catch (InterruptedException e) {
						System.out.println("Thread awoken early : " + e);
					}
				}
			}

			// One finished reading frames: tidy up
			try {
				in.close();
			} catch (IOException e) {
				System.out.println("Error Closing");
			}
		}


		 *//**
		 * Sends Frame to the server
		 * @param frame
		 **//*
		private void sendFrame(Frame frame){
			try{
				DataOutputStream dos = new DataOutputStream(client.getOutputStream());
				ObjectOutputStream oos = new ObjectOutputStream(dos);
				System.out.println("Sending frame " + frame.getSequenceNumber()+ ": " +  frame.getData());
				oos.writeObject(frame);
				System.out.println("Frame sent to server");
				frames.add(frame);
			} catch (Exception exception){
				System.out.println("Sending data failed - " + exception);
			}
		}*/
	}

	/*
	static class Receiver extends Thread{
		@Override
		public void run(){
			try{
				DataInputStream dataInputStream = new DataInputStream(client.getInputStream());
				ObjectInputStream objectInputStream = new ObjectInputStream(dataInputStream);
				while(true){
					if(client.isInputShutdown()){
						break;
					}
					try{
						Integer integer = (Integer)objectInputStream.readObject(); 
						System.out.println("Int  = " + integer.intValue());
					} catch (EOFException eofException){
						try{
							System.out.println("Sleeping for 1s");
							sleep(1000);
						} catch (InterruptedException e) {
							System.out.println("Thread awoken on receiver");
							break;
						}
					}
				}
			}catch (IOException e) {
				System.out.println("Io Exception On Receiver");
			} catch (ClassNotFoundException e) {
				System.out.println("Class not found exception on receiver");
			}

		}

		/*		@Override
		public void run() {
			System.out.println("Receiver Run");
			while(running) {
				try {
					DataInputStream dis = new DataInputStream(client.getInputStream());
					ObjectInputStream ois = new ObjectInputStream(dis);
//					objectInputStream = new ObjectInputStream(dataInputStream);
					Frame frame = (Frame) ois.readObject();
					if(frame.getData().equals("a")) {
						System.out.println("Ack received for frame " + frame.getSequenceNumber());
						for(int i=0;i<frames.size();i++) {
							if(frames.get(i).getSequenceNumber() == frame.getSequenceNumber()) {
								frames.remove(i);
								break;
							}
						}
					} else if(frame.getData().equals("n")) {
						System.out.println("Nack received on frame " + frame.getSequenceNumber());
					} else {
						System.out.println("Unknown frame received: " + frame.getData());
					}
				} catch (EOFException eof) {
					try {
						sleep(500);
					} catch (InterruptedException e) {
						System.out.println("Sleep interupt : " + e);
					}
				}

				catch (ClassNotFoundException cnf) {
					System.out.println("Error Unpacking Frame : " + cnf);
				}

				catch (IOException io) {
					System.out.println("Error Unpacking Frame : " + io);
				}
			}
		}
	} */
}